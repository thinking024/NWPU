# 一、 **操作系统概述**

（一）  操作系统的概念、特征、功能和提供的服务

- OS作为用户与计算机硬件系统之间的接口
- OS作为计算机系统资源的管理者
- OS实现了对计算机资源的抽象

（二）  操作系统的发展与分类

（三）  操作系统的运行环境

------

内核态与用户态

- 内核态：用于运行内核程序，执行特权指令
- 用户态：用户运行应用程序

-------

中断与异常

- 中断（外中断）：来自于CPU外部的信号引发，如I/O中断、时钟中断
- 异常（内中断）：来自于CPU内部的信号引发，陷入trap、故障fault、终止abort

系统调用：应用程序发起系统调用请求，传递参数，执行陷入指令，进入内核态，处理完系统调用后返回用户态

（四）操作系统体系结构



# 二、进程管理

## （一）进程与线程

进程概念、进程的状态与转换、进程控制、进程组织

------------------------

**进程通信**

- 共享存储
  - 共享数据结构
  - 共享存储区

- 管道通信 
- 消息传递
  - 直接消息传递
  - 信箱通信
- C/S

线程概念与多线程模型

## （二）处理机调度

调度的基本概念，调度的基本准则，调度时机、切换与过程、调度方式

- 高级调度/长程调度/作业调度：将外存中的后备队列的**作业**调入内存，并为其**创建进程**、分配资源，**周期最长**
- 中级调度/内存调度：将外存中的**就绪挂起进程**调入内存，变为就绪态
- 低级调度/短程调度/：决定哪个就绪进程能获得CPU，最常见，**运行最频繁**

-----

**典型调度算法：**

评估时间

- 周转时间=完成时间-到达时间
- 带权周转时间=周转时间/运行时间
- 等待时间=周转时间-运行时间

算法

- 先来先服务：不利于短作业
- 短作业（短进程、短线程）优先：需要预知作业运行时间，不利于长作业，**平均等待时间最少**
  - 改进：最短剩余时间优先，**抢占式**
- 最高响应比优先：响应比=（等待时间+所需运行时间）/所需运行时间，兼顾了等待时间与运行时间，是先来先服务与短作业优先的中和办法，**非抢占**
- 时间片轮转：通过时钟中断实现，高频率的进程切换，**抢占式**
- 优先级：有抢占与非抢占式，有静态优先级与动态优先级，**饥饿**
- 多级反馈队列调度算法：设置多个就绪队列，每个队列有不同的优先级，**抢占式，饥饿**
  - 不同队列间采用优先级
  - 队列内的进程采用先来先服务+时间片轮转，时间片内未执行完则进入低一级的队列末尾

----

## （三）进程同步与互斥

进程同步的基本概念：进程具有异步性，保证进程以一定的次序执行

一次只允许一个进程使用的资源称为临界资源，访问临界资源的那段代码称为临界区

实现临界区互斥的基本方法：

- 硬件实现方法
  - 中断禁用：不切换进程
  - Test-and-Set指令
  - Swap指令
- 软件实现方法

### 信号量

- 基本使用
  - S：资源的数量，若<0，则代表等待资源的进程数目

  - wait/P

  ```c
  void wait(Semaphore s)
  {
      s.value--; // 申请资源
      if (s.value < 0)  // 若资源不够，则阻塞自己
      {
          block(s.L);
      }
  }
  ```

  - signal/V

  ```c
  void signal(Semaphore s)
  {
      s.value++; // 释放资源
      if (s.value <= 0) // 若有进程等待，则唤醒此进程。s=0代表执行上一步之前s=-1
      {
          wake(s.L);
      }
  }
  ```

- 实现互斥
  - 互斥信号量mutex=1
  - 进临界区前，执行P；出临界区后，执行V；P、V都是在自己一个进程中成对出现

- 实现同步
  - 同步信号来semaphore根据需求设定
  - P、V操作往往分别出现在需要同步的多个进程中

- 同步P先于互斥P执行

**管程**：共享数据+对这些数据进行操作的内部过程，每次仅允许一个进程在管程内部执行过程

经典同步问题：生产者-消费者问题、读者-写者问题、哲学家进餐问题等

## （四）死锁

**概念**：在并发环境下，各进程因竞争资源而造成的一种互相等待对方手里的资源，导致各进程都阻塞，都无法向前推进

**发生的四个须同时满足的条件**

- 互斥：资源互斥使用
- 不剥夺：资源只能由进程主动释放，不能被强行剥夺
- 请求和保持：进程自己拥有资源不放，同时又请求其他进程拥有的资源
- 循环等待：资源在多个进程中的循环等待

**处理策略**

- 死锁预防：破坏四个条件之一

- 死锁避免
  - 系统安全状态：至少存在一个安全序列（系统按照这种序列分配资源，则每个进程都能顺利完成）的状态。此时一定不会发生死锁
  - 银行家算法

- 死锁检测和解除
  - 监测：画出图
  - 解除
    - 剥夺资源
    - 终止进程
    - 回退进程



# 三、内存管理

## （一）内存管理基础

内存管理概念

程序装入与链接分为三步

1. 编译
2. 链接
    - 静态链接
    - 装入时动态链接
    - 运行时动态链接
3. 装入
    - 绝对装入
    - 可重定位装入
    - 动态运行时装入

- 逻辑地址：程序运行时的地址，供用户使用

- 物理地址空间：程序在内存中的地址

内存保护

- 内存中设一对上下限寄存器
- 采用重定位寄存器+界地址寄存器

交换与覆盖：用于扩充内存

- 覆盖：将用户空间分为一个固定区+若干覆盖区，一个进程的信息无需全部放入内存
- 交换：将处于等待中的程序换到外存中

### 连续分配管理方式

- 单一连续分配：划分为系统区和用户区，有**内碎片**
- 固定分区分配：用户空间分区大小固定，装不进大进程，有**内碎片**
  - 分区大小相等
  - 分区大小不等
- 动态分区分配：根据进程大小动态创建分区，有**外碎片**，可通过紧凑技术解决
  - 首次适应：每次从低地址开始找到第一个能装下的空闲分区
  - 下次适应/循环首次适应：从上一次找到的空闲分区后开始，找到第一个能装下的空闲分区
  - 最佳适应/最小适应：每次选能装下且最小的空闲分区，有**外碎片**
  - 最坏适应/最大适应：每次选能装下且最大的空闲分区，

### 非连续分配管理方式

允许一个程序分散地装入不相邻的内存分区

- 分页管理方式
  - 页框/块：内存中的分区；页：进程的地址空间，大小固定；将页装入页框中，页与页框大小一样
  - 使用页表：存放入页表寄存器中，完成页号到块号的映射。页表过大不好全装入内存时，可使用**多级页表**节省内存，使用时间换空间
  - 使用快表：利用局部性原理，先去快表中找，找不到再去页表找，加快查找速度，使用空间换时间
  - 逻辑地址变换为物理地址
    - 页号=逻辑地址/页面大小
    - 页内偏移量=逻辑地址%页面大小
    - 通过页表将页号->块号
    - 物理地址=块号*页面大小+页内偏移量
  - 最后一页总是装不满，存在**内碎片**
- 分段管理方式
  - 段：根据需要将程序逻辑分段，段的长度不固定
  - 段表：包含段号+该段长度+该段起始地址
- 段页式管理方式
  - 先分段，再将每段分为若干页
  - 地址由段号+段内页号+页内地址构成
  - 先去段表，根据段号找到对应的页表地址
  - 再去页表中，根据页号找到对应的块号
  - 再根据块号*页面大小+页内偏移量得到最终物理地址

-----



## （二）  虚拟内存管理

虚拟内存基本概念

### 1. 请求分页管理方式

- 请求页表机制：页号、物理块号、状态位P（是否在内存中）、访问字段A（最近被访问的次数）、修改位M、外存地址
- 缺页中断机构：要访问的部分尚未调入内存，则产生中断
- 地址变换机构

#### 页面置换算法

- 最佳置换算法（OPT）：预知要使用的页面序列，将未来最长时间内不再使用的页面换出

- 先进先出置换算法（FIFO）：易抖动，**存在belady现象**（页框数增加时，缺页率反而上升）

- 最近最久使用置换算法（LRU）：将最久未被使用过的（即max{now-上次使用时间}）的页面换出，需要寄存器和栈的硬件支持

- 最少使用置换算法（LFU）

- 时钟置换算法

  - 简单CLOCK：为每个页面设置一个访问位，每次使用此页，将其置为1。需要替换时，按下列做法
    - 如果是0，就选择该页换出
    - 如果是1，则将它置为0，暂不换出，继续检查下一个页面
    - 若第一轮扫描中所有页面都是1，则将这些页面的访问位依次置为0后，再进行第二轮扫描

  - 改进CLOCK：为每个页面设置访问位+修改位，在简单CLOCK的基础上，优先换出未访问未修改的页面

#### 页面分配策略

- 驻留集：给进程分配的物理块的集合

- 工作集：进程要访问的页面的集合
- 驻留集>工作集，否则将缺页

- 内存分配策略
  - 固定分配：运行前分配好驻留集大小，运行中不变
  - 可变分配：运行中可变

- 置换策略
  - 全局置换：可以将操作系统保留的空闲物理块分配给缺页进程，也可以将别的进程持有的物理块置换到外存，再分配给缺页进程
  - 局部置换：发生缺页时只能选进程自己的物理块进行置换

- 上述两两组合
  - 固定分配局部置换
  - 可变分配全局置换
  - 可变分配局部置换

### 2. 请求分段管理

### 3. 请求段页式管理



# 四、文件管理

## （一）  文件系统基础

**文件概念**：文件、记录、数据项（字段）三层结构

**文件的逻辑结构**（文件组织）：按组织方式，将有结构文件分类

- 顺序文件：文件中的记录逻辑上有顺序
  - 串结构：类似链表，每次必须从头开始查找
  - 顺序结构：指定一个字段作为关键字，按关键字排序
- 索引文件：为主文件中的每一个记录建立索引表项，索引表本身也是顺序结构的文件；可根据需要设置多个索引
- 索引顺序文件：为主文件的一组记录建立索引表项，可以设置多级索引提高查找效率
- 直接文件/哈希文件

 **文件目录**

- 一个文件控制块FCB就是一个文件目录项，FCB的有序集合就是文件目录
- 索引节点：文件描述信息单独构成一个索引节点
- 文件目录结构
  - 单级：按名存取
  - 两级：分主文件目录、用户文件目录
  - 树形目录结构：多级目录结构
  - 图形目录结构：便于文件共享

 **文件共享**

- 硬链接：基于索引节点，允许一个文件拥有多个有效路径名
- 软链接：基于符号链，类似于windows快捷方式

 **文件保护**

- 访问类型
  - 读
  - 写
  - 执行
  - 添加
  - 删除
  - 列表清单
- 口令
- 加密保护
- 访问控制：在FCB中添加访问控制列表



## （二）  文件系统实现

**文件系统层次结构**

1. 用户调用接口
2. 文件目录系统
3. 存取控制验证模块
4. 逻辑文件系统与缓冲区
5. 物理文件系统
6. 辅助分配模块
7. 设备管理模块

**目录实现**

- 线性列表
- 哈希表

**文件实现**

- 磁盘的物理地址被划分为磁盘块，以块为单位进行读写

- 文件的逻辑地址被划分为文件块，表示为逻辑块号+块内地址

- 文件的物理结构（文件存储/分配方式）

  - 连续分配：为每个文件分配连续的磁盘块，按顺序寻找最快，但空间利用率低
  - 链接分配
    - 隐式链接：文件的每个盘块像链表一样组织，文件目录项中含有链表的头、尾指针
    - 显示链接：将磁盘中所有文件的各个盘块的指针显示的放在内存里的一张文件分配表FAT中，将该文件的第一个块地址放入自己的FCB中

  - 索引分配方式
    - 单级索引：每个文件都设置索引表，索引存放在磁盘块中
    - 多级索引
    - 增量式索引：单级和多级索引的方式混合使用

- 文件存储空间/磁盘空闲管理
  - 空闲表：记录起始空闲盘号+从此处开始空闲的盘块数量，形成表格，连续分配
  - 空闲链表：操作系统保存头、尾指针
    - 空闲盘块链：以空闲的盘块为单位形成链表
    - 空闲盘区链：连续的空闲盘块构成空闲盘区，以盘区为单位形成链表
  - 位示图：用0、1的二阶矩阵形式表示盘块是否空闲
  - 成组链接



## （三）  磁盘组织与管理

- 磁盘的结构

  - 磁盘有多个盘面，每个盘面配有一个磁头，盘面上有若干磁道形成同心圆，磁道逻辑上划分为扇区

  - 磁头伸缩先寻找磁道，再等到扇区旋转

- 磁盘调度算法
  - 先来先服务（FCFS）：根据进程请求访问磁盘的先后顺序进行调度处理
  - 最短寻道时间优先（SSTF）：选择调度处理的磁道是与当前磁头所在磁道距离最近的磁道
  - 扫描/电梯算法（SCAN）：在磁头**当前移动方向上**选择与当前磁头所在磁道距离最近的请求作为下一次服务的对象
  - 循环扫描（CSCAN）：在扫描算法的基础上，规定磁头只能**单向移动**，只能从里到外扫描，不能从外到里
  - NStepSCAN：将请求分为N个队列，对每个队列FCFS，队列内按SCAN，**避免磁臂黏着**
  - FSCAN：对NStepSCAN的简化，分为两个队列，一个按SCAN处理当前请求，另一个存放新来的请求

- 磁盘的管理 



# 五、输入输出（I/O）管理

## （一）  I/O管理概述

 I/O控制方式

- 直接程序控制：CPU采用轮询的方式，不断地测试I/O设备的状态
- 中断：CPU向I/O设备发出I/O命令后，保存程序上下文，继续去做其他事情。I/O设备处理完后，发出中断通知CPU
- 直接存储器访问DMA：只在开始和结束的时候需要CPU参与，其余的时间交给DMA控制器，数据不经过CPU的寄存器，直接送入内存
- 通道控制方式：DMA的发展形式，传输数据单位从一个数据块->一组数据块

 I/O软件层次结构

1. 用户I/O软件
2. 设备独立性软件
3. 设备驱动程序
4. 中断处理程序
5. 硬件设备

## （二）  I/O核心子系统

I/O调度概念：确定一个好的顺序来执行这些I/O请求

出错处理

磁盘高速缓存：提高磁盘I/O速度，存放磁盘上数据的复制品

- 在内存中开辟一个单独的空间作为磁盘高速缓存，大小固定
- 将未利用的内存空间作为一个缓冲池，供请求分页系统和磁盘I/O共享

### 缓冲区

引入原因

- 解决CPU与I/O设备速度不匹配
- 减少CPU中断频率
- 解决数据粒度不匹配
- 提高CPU与I/O设备的并行性

单缓冲：CPU数据处理时间与数据从外存到缓冲区的时间并行

双缓冲：避免了单缓冲满的问题，同时可以使两台机器双工通信

假脱机技术（SPOOLing）：以空间换时间，在磁盘上设置输入井、输出井，先将I/O设备中的数据送入井中，在内存中设置输入、输出缓冲区，使独占设备虚拟变为共享设备，使得多个进程可以使用独占设备

设备分配与回收